{% extends "layouts/base-fullscreen.html" %}
{% block title %} Template page {% endblock %} 
<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<!-- <link type="text/css" href="/static/assets/css/pixel.css" rel="stylesheet"> -->
<link type="text/css" href="/static/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/main.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/report.css" rel="stylesheet">
{% endblock stylesheets %}
{% block content %}
    <main>
        {% include 'includes/preloader2.html' %}
        <div class="main-background">
            {% include 'includes/sidebar.html' %}
            <div class="main-body">
                <div class="main-body-header">
                </div>
                <div class="full-screen-section margin-all-10">
                    {% raw %}
                    <div id="app" style="width: 100%;">
                        <form class="needs-validation" novalidate="" @submit="checkForm">
                            <div class="row flex-between-end mb-5">
                                <div class="col-auto">
                                    <h2 class="mb-2">Template page</h2>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-secondary me-2 mb-2 mb-sm-0" type="button">Discard</button>
                                    <button class="btn btn-primary mb-2 mb-sm-0" type="submit">Save</button>
                                </div>
                            </div>
                            <div class="row g-5">
                            <div class="col-12 col-xl-8">
                                <h4 class="mb-3">Report title</h4>
                                <input v-model="title" class="form-control mb-5" type="text" placeholder="Write title here..." required>
                                <h4 class="mb-3">Report template</h4>
                                <draggable v-model="template" :element="'div'">
                                    <div v-for="element in template" :key="element.id">
                                        <div v-if="element.type === 'text'" class="template-group">
                                            <textarea v-model="element.content" required></textarea>
                                            <button class='btn-close-id btn-close ms-2' @click="removeElement(element)"></button>
                                        </div>
                                        <div v-else-if="element.type === 'graph'" class="template-group">
                                            <span class="badge badge-success">GRAPH</span>
                                            <div class="template-el-label">Name: {{ element.content }}</div>
                                            <div class="flex-end">
                                                <button class='btn-close-id btn-close' @click="removeElement(element)"></button>
                                            </div>
                                        </div>
                                        <div v-else-if="element.type === 'template'" class="template-group">
                                            <span class="badge badge-primary">TEMPLATE</span>
                                            <div class="template-el-label">Name: {{ element.content }}</div>
                                            <div class="flex-end">
                                                <button class='btn-close-id btn-close' @click="removeElement(element)"></button>
                                            </div>
                                        </div>
                                    </div>
                                </draggable>
                                <button class="btn btn-primary mt-3" @click="addTextElement">Add Text</button>
                            </div>
                            <div class="col-12 col-xl-4">
                                <div class="row g-2">
                                    <div class="col-12 col-xl-12">
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <div class="margin-all-10">
                                                    <label for="template">Template name</label>
                                                    <input v-model="name" class="form-control" type="text" required>
                
                                                </div>
                                                <div class="margin-all-10">
                                                    <label for="flow">Flow name</label>
                                                    <v-select v-model="flow" class="vue-select-imput" :options="flows" label="flow" :attrs="{ required: true }">
                                                    </v-select>
                                                    
                                                </div>
                                                <div class="margin-all-10">
                                                    <label>Add graph</label>
                                                    <v-select class="vue-select-imput" :options="graphs" label="graph" @input="addGraphElement" required></v-select>
                                                </div>
                                                <div class="margin-all-10">
                                                    <label>Add template</label>
                                                    <v-select class="vue-select-imput" :options="templates" label="template" @input="addTemplateElement" required></v-select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-xl-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <div>
                                                    <label>Available variables:</label>
                                                    <div>
                                                        <label class="var-name">${current_vusers}:</label>
                                                        <label class="var-description">Max number of threads</label>
                                                    </div>
                                                    <div>
                                                        <label class="var-name">${current_duration}:</label>
                                                        <label class="var-description">Duration of the test.</label>
                                                    </div>
                                                    <div>
                                                        <label class="var-name">${current_start_time}:</label>
                                                        <label class="var-description">Start datetime for the test.</label>
                                                    </div>
                                                    <div>
                                                        <label class="var-name">${current_end_time}:</label>
                                                        <label class="var-description">End datetime for the test.</label>
                                                    </div>
                                                    <div>
                                                        <label class="var-name">${current_grafana_link}:</label>
                                                        <label class="var-description">Link to Grafana dashboard with test results.</label>
                                                    </div>
                                                    <div>
                                                        <label class="var-name">${baseline_vusers}:</label>
                                                        <label class="var-description">Max number of threads for baseline test (If specified).</label>
                                                    </div>
                                                    <div>
                                                        <label class="var-name">${baseline_duration}:</label>
                                                        <label class="var-description">Duration of the baseline test (If specified).</label>
                                                    </div>
                                                    <div>
                                                        <label class="var-name">${baseline_start_time}:</label>
                                                        <label class="var-description">Start datetime for the baseline test (If specified).</label>
                                                    </div>
                                                    <div>
                                                        <label class="var-name">${baseline_end_time}:</label>
                                                        <label class="var-description">End datetime for the baseline test (If specified).</label>
                                                    </div>
                                                    <div>
                                                        <label class="var-name">${baseline_grafana_link}:</label>
                                                        <label class="var-description">Link to Grafana dashboard with baseline test results (If specified).</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    {% endraw %}
                </div>
                {% with msgs = get_flashed_messages() %}
                    {% include 'includes/flashed-msg.html' %}
                {% endwith %}
            </div>
        </div>
        <script src="//cdnjs.cloudflare.com/ajax/libs/vue/2.5.2/vue.min.js"></script>
        <!-- CDNJS :: Sortable (https://cdnjs.com/) -->
        <script src="//cdn.jsdelivr.net/npm/sortablejs@1.8.4/Sortable.min.js"></script>
        <!-- CDNJS :: Vue.Draggable (https://cdnjs.com/) -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/2.20.0/vuedraggable.umd.min.js"></script>
        <script src="https://unpkg.com/vue-select@latest"></script>
        <link rel="stylesheet" href="https://unpkg.com/vue-select@latest/dist/vue-select.css">

        <script>
            Vue.component('v-select', {
            extends: VueSelect.VueSelect,
            props: ['attrs'],
            });

            const app = new Vue({
                el: '#app',
                data() {
                    return {
                        graphs: [],
                        templates: [],
                        flows: "",
                        flow: "",
                        name: "",
                        title: "",
                        template: [
                            { id: 1, type: 'text', content: 'some text' },
                            { id: 2, type: 'graph', content: 'AVG' },
                            { id: 3, type: 'text', content: 'some text' },
                        ],
                    };
                },
                methods: {
                    addTextElement() {
                        const newId = this.template.length + 1;
                        this.template.push({ id: newId, type: 'text', content: '' });
                    },
                    addGraphElement(element) {
                        if (element !== null) {
                            const newId = this.template.length + 1;
                            this.template.push({ id: newId, type: 'graph', content: element });
                        }
                    },
                    addTemplateElement(element) {
                        if (element !== null) {
                            const newId = this.template.length + 1;
                            this.template.push({ id: newId, type: 'template', content: element });
                        }
                    },
                    removeElement(element) {
                        const index = this.template.indexOf(element);
                        if (index !== -1) {
                            this.template.splice(index, 1);
                        }
                    },
                    saveTemplate() {
                        const result = {
                            "name": this.name,
                            "flow": this.flow,
                            "title": this.title,
                            "data": this.template
                        }
                        perforge.utils
                            .sendPostRequest("/template", JSON.stringify(result))
                            .then((redirectUrl) => {
                                // window.location.replace(redirectUrl);
                            })
                            .catch((error) => {
                                console.error("Request failed:", error);
                            });
                    },
                    checkForm() {
                        const form = document.querySelector(".needs-validation");
                        perforge.utils.validateForm(form, event, (result) => {
                            alert(result);
                                    // if (result) {
                                    //     perforge.utils
                                    //     .sendPostRequest("/nfr", getNFRs())
                                    //     .then((redirectUrl) => {
                                    //         window.location.replace(redirectUrl);
                                    //     })
                                    //     .catch((error) => {
                                    //         console.error("Request failed:", error);
                                    //     });
                                    //}
                        });
                        // if (this.name && this.age) {
                        //     return true;
                        // }

                        // this.errors = [];

                        // if (!this.name) {
                        //     this.errors.push('Name required.');
                        // }
                        // if (!this.age) {
                        //     this.errors.push('Age required.');
                        // }

                        // e.preventDefault();
                    },
                },
                created() {
                    this.graphs = JSON.parse('{{ graphs | tojson }}');
                    this.templates = JSON.parse('{{ templates | tojson }}');
                    this.flows = JSON.parse('{{ flows | tojson }}');
                },
            });
        </script>
    </main>
    {% include 'includes/footer.html' %}
{% endblock content %}