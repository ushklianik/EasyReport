{% extends "layouts/base-fullscreen.html" %}
{% block title %} Azure {% endblock %} 
<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<link type="text/css" href="/static/assets/css/pixel.css" rel="stylesheet">
<link type="text/css" href="/static/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/report.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/nfrs.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/main.css" rel="stylesheet">
{% endblock stylesheets %}
{% block content %}
    <main>
        <div class="main-background">
            {% include 'includes/sidebar.html' %}
            <div class="main-body">
                <div class="justify-content-start main-body-header">
                    <a class="text-white footer-logo-text">NFR</a>
                </div> 
                <div class="nfrs-container" id="nfrs-container">
                    <div class="row marging-10">
                        <div class="col-auto">
                            <label class="col-form-nfr-label">App name:</label>
                        </div>
                        <div class="col-auto">
                            <input name="appName" id="appName" class="form-control-nfr">
                        </div>
                    </div>
                    <div class="row marging-10">
                        <div class="nfr-col-l">
                            <div style="display:flex;flex-direction: column;">
                                <label class="col-form-nfr-label" style="flex:1;">Scope:</label>
                                <label class="col-form-nfr-description" style="flex:1;">You can define the scope to which the NFRs check will be applied.
                                    all: calculates metrics for all requests
                                    each: calculates metrics for each request. 
                                    Also you can specify request/transaction name.
                                </label>
                            </div>
                        </div>
                        <div class="nfr-col-m">
                            <label class="col-form-nfr-label">Metric:</label>
                            <label class="col-form-nfr-description" style="flex:1;">What metric should be calculated for the specified scope.</label>
                        </div>
                        <div class="nfr-col-s">
                            <label class="col-form-nfr-label">Aggregation:</label>
                            <label class="col-form-nfr-description" style="flex:1;">What aggregation will be used to calculate metric value.</label>
                        </div>
                        <div class="nfr-col-s">
                            <label class="col-form-nfr-label">Operation:</label>
                            <label class="col-form-nfr-description" style="flex:1;">What comparison operation will be used to compare metric value with treshold.</label>
                        </div>
                        <div class="nfr-col-m">
                            <label class="col-form-nfr-label">Threshold:</label>
                            <label class="col-form-nfr-description" style="flex:1;">Only number should be specified.</label>
                        </div>
                        <div class="nfr-col-m" style="width: 18%;">
                            <label class="col-form-nfr-label">Weight (optional):</label>
                            <label class="col-form-nfr-description" style="flex:1;">You can specify which weight belongs to each NFR. This is an optional field. If not specified, all NFS will have the same weight.
                                Only number should be specified.
                                The sum of the total weight in one set should not exceed 100</label>
                        </div>
                        <div class="nfr-col-m" style="display: flex;width: 10%;">
                        </div>
                    </div>
                </div>
                <div class="nfrs-container">
                    <div id="nfrs-panel">
                        <button onclick="addNfrRow()" class="btn nfr-btn" style="margin-right: 1rem;">New row</button>
                        <button onclick="saveNFRs()" class="btn nfr-btn">Save NFRs</button>
                    </div>
                </div>
            </div>
        </div>
        <script>
            var row = '<div class="row marging-10 nfr-row">'+
                            '<div class="nfr-col-l">'+
                                '<input name="scope-nfr-field" class="form-control-nfr scope-nfr-field">'+
                            '</div>'+
                            '<div class="nfr-col-m">'+
                                '<select name="metric-nfr-field" class="form-select-nfr metric-nfr-field">'+
                                    '<option value="response-time" selected>response time</option>'+
                                    '<option value="rps">rps</option>'+
                                    '<option value="errors">errors</option>'+
                                '</select>'+
                            '</div>'+
                            '<div class="nfr-col-s">'+
                                '<select name="aggregation-nfr-field" class="form-select-nfr aggregation-nfr-field">'+
                                    '<option value="avg" selected>avg</option>'+
                                    '<option value="median">median</option>'+
                                    '<option value="90">90%-tile</option>'+
                                    '<option value="95">95%-tile</option>'+
                                    '<option value="count">count</option>'+
                                    '<option value="sum">sum</option>'+
                                '</select>'+
                            '</div>'+
                            '<div class="nfr-col-s">'+
                                '<select name="operation-nfr-field" class="form-select-nfr operation-nfr-field" >'+
                                    '<option value=">" selected>></option>'+
                                    '<option value="<"><</option>'+
                                    '<option value="=">=</option>'+
                                    '<option value="!=">!=</option>'+
                                    '<option value=">=">>=</option>'+
                                    '<option value="<="><=</option>'+
                                '</select>'+
                            '</div>'+
                            '<div class="nfr-col-m">'+
                                '<input name="threshold-nfr-field" class="form-control-nfr threshold-nfr-field" >'+
                            '</div>'+
                            '<div class="nfr-col-m" style="width: 18%;">'+
                                '<input name="weight-nfr-field" class="form-control-nfr weight-nfr-field" >'+
                            '</div>'+
                            '<div class="nfr-col-m" style="display: flex;width: 10%;">'+
                                '<button onclick="deleteNfrRow(this)" class="btn nfr-btn-red" style="align-self: flex-end;">Delete</a>'+
                            '</div>'+
                        '</div>'
            function addNfrRow() {
                var container = document.getElementById("nfrs-container");
                container.insertAdjacentHTML("beforeend", row);
            } 

            function deleteNfrRow(elem) {
                elem.parentNode.parentNode.remove();
            }
            function saveNFRs(){
                var appName = document.getElementById("appName");
                var nfrsPanel = document.getElementById("nfrs-panel");
                var rows = document.getElementsByClassName("nfr-row");
                var nfrs = {}
                nfrs["appName"]=appName.value
                nfrs["rows"] = []
                for(var i = 0; i < rows.length; i++) {
                    let dict = {}
                    dict["scope"] = rows[i].querySelector('.scope-nfr-field').value
                    dict["metric"] = rows[i].querySelector('.metric-nfr-field').value
                    dict["aggregation"] = rows[i].querySelector('.aggregation-nfr-field').value
                    dict["operation"] = rows[i].querySelector('.operation-nfr-field').value
                    dict["threshold"] = rows[i].querySelector('.threshold-nfr-field').value
                    dict["weight"] = rows[i].querySelector('.weight-nfr-field').value
                    nfrs["rows"].push(dict)
                }
                $.ajax({
                    url:'/nfr',
                    type:"POST",
                    data:JSON.stringify(nfrs),
                    contentType:"application/json",
                    success: function(){
                        if(nfrsPanel.querySelector('.status-message') != null){
                            nfrsPanel.querySelector('.status-message').remove();
                        }
                        let elem = '<div class="good-msg status-message">Saved</div>';
                        nfrsPanel.insertAdjacentHTML("beforeend", elem);
                    },
                    error: function () {
                        if(nfrsPanel.querySelector('.status-message') != null){
                            nfrsPanel.querySelector('.status-message').remove();
                        }
                        let elem = '<div class="bad-msg status-message">Not saved</div>';
                        nfrsPanel.insertAdjacentHTML("beforeend", elem);
                    },
                })
            }

            var nfrsPanel = document.getElementById("nfrs-panel");
            var appName = document.getElementById("appName");
            var nfrsJson = JSON.parse('{{ nfrs | tojson }}');
                if(nfrsJson["status"] != null){
                   if(nfrsJson["status"] == "error"){
                        if(nfrsPanel.querySelector('.status-message') != null){
                            nfrsPanel.querySelector('.status-message').remove();
                        }
                        let elem = '<div class="bad-msg status-message">'+nfrsJson["message"]+'</div>';
                        nfrsPanel.insertAdjacentHTML("beforeend", elem);
                   }
                }
                if(nfrsJson["appName"] != null){
                    appName.value = nfrsJson["appName"]
                    for(var i = 0; i < nfrsJson["rows"].length; i++) {
                        var container = document.getElementById("nfrs-container");
                        var newRow = '<div class="row marging-10 nfr-row">'+
                            '<div class="nfr-col-l">'+
                                '<input name="scope-nfr-field" value="'+nfrsJson["rows"][i]["scope"]+'" class="form-control-nfr scope-nfr-field">'+
                            '</div>'+
                            '<div class="nfr-col-m">'+
                                '<select name="metric-nfr-field" class="form-select-nfr metric-nfr-field">'+
                                    '<option value="'+nfrsJson["rows"][i]["metric"]+'" selected>'+nfrsJson["rows"][i]["metric"]+'</option>'+
                                    '<option value="response-time">response time</option>'+
                                    '<option value="rps">rps</option>'+
                                    '<option value="errors">errors</option>'+
                                '</select>'+
                            '</div>'+
                            '<div class="nfr-col-s">'+
                                '<select name="aggregation-nfr-field" class="form-select-nfr aggregation-nfr-field">'+
                                    '<option value="'+nfrsJson["rows"][i]["aggregation"]+'" selected>'+nfrsJson["rows"][i]["aggregation"]+'</option>'+
                                    '<option value="avg">avg</option>'+
                                    '<option value="median">median</option>'+
                                    '<option value="90">90%-tile</option>'+
                                    '<option value="95">95%-tile</option>'+
                                    '<option value="count">count</option>'+
                                    '<option value="sum">sum</option>'+
                                '</select>'+
                            '</div>'+
                            '<div class="nfr-col-s">'+
                                '<select name="operation-nfr-field" class="form-select-nfr operation-nfr-field" >'+
                                    '<option value="'+nfrsJson["rows"][i]["operation"]+'" selected>'+nfrsJson["rows"][i]["operation"]+'</option>'+
                                    '<option value=">">></option>'+
                                    '<option value="<"><</option>'+
                                    '<option value=">=">=</option>'+
                                    '<option value="!=">!=</option>'+
                                    '<option value=">=">>=</option>'+
                                    '<option value="<="><=</option>'+
                                '</select>'+
                            '</div>'+
                            '<div class="nfr-col-m">'+
                                '<input name="threshold-nfr-field" value="'+nfrsJson["rows"][i]["threshold"]+'"class="form-control-nfr threshold-nfr-field" >'+
                            '</div>'+
                            '<div class="nfr-col-m" style="width: 18%;">'+
                                '<input name="weight-nfr-field" value="'+nfrsJson["rows"][i]["weight"]+'"class="form-control-nfr weight-nfr-field" >'+
                            '</div>'+
                            '<div class="nfr-col-m" style="display: flex;width: 10%;">'+
                                '<button onclick="deleteNfrRow(this)" class="btn nfr-btn-red" style="align-self: flex-end;">Delete</a>'+
                            '</div>'+
                        '</div>'
                        container.insertAdjacentHTML("beforeend", newRow);
                    }
                }
            var nfRows = document.getElementsByClassName("nfr-row");
            if (nfRows.length == 0){
                var container = document.getElementById("nfrs-container");
                container.insertAdjacentHTML("beforeend", row);
            }
        </script>
    </main>
    {% include 'includes/footer.html' %}
{% endblock content %}